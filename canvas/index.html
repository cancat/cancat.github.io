<html lang="zh">
	<head>
		<meta charset="utf-8" />
		<title>Canvas-Filter</title>
		<style type="text/css">
			#layer-pointer {
				display: none;
				position: absolute;
				padding: 2px 4px;
				background: #f7f7f7;
				border: 1px solid #333;
				font-size: 12px;
			}
		</style>
		<script src="js/ImageManager.js"></script>
		<script src="js/Scene.js"></script>
		<script type="text/javascript">
			var Filters = {};

			Filters.getCanvas = function(w,h) {
			    var c = document.createElement('canvas');
			    c.width = w;
			    c.height = h;
			    return c;
			};

			Filters.filter = function(filter, img, args) {
				var c = this.getCanvas(img.width, img.height);
				var ctx = c.getContext('2d');
				ctx.drawImage(img,0,0);
				var argus = imgData = ctx.getImageData(0,0,c.width,c.height);
				if (!!args) {
					argus = [imgData, args]
				}
				var filtered = !!filter?filter.apply(null,argus):imgData;
				ctx.putImageData(filtered,0,0);
				return c;
			}

			var grayscale = function(pixels) {
			    var d = pixels.data;
			    for (var i=0; i<d.length; i+=4) {
			        var r = d[i];
			        var g = d[i+1];
			        var b = d[i+2];
			        // CIE luminance for the RGB
			        // The human eye is bad at seeing red and blue, so we de-emphasize them.
			        var v = 0.2126*r + 0.7152*g + 0.0722*b;
			        d[i] = d[i+1] = d[i+2] = v
			   }
			   return pixels;
			};

			var multiply = function(pixels,color) {
				var d = pixels.data;
				for (var i=0; i<d.length; i+=4) {
					d[i] *= color[0] / 255;
					d[i+1] *= color[1] / 255;
					d[i+2] *= color[2] / 255;
				}
				return pixels;
			}

			var toRgb = function(hex) {
				var r = parseInt(hex.substr(1,2),16);
				var g = parseInt(hex.substr(3,2),16);
				var b = parseInt(hex.substr(5,2),16);
				return [r, g, b];
			}

			
			var imageManager = new ImageManager();
			imageManager.load({
				'layer-0': 'img/demo.png',
				'layer-1': 'img/test.png'
			}, function () {
				var canvas = document.getElementById('mainCanvas');
				var scene = new Scene(canvas, imageManager);
				scene.draw(canvas);
				var multiply_btn = document.getElementById('multiply-btn');
				var reset_btn = document.getElementById('reset-btn');
				var color_picker = document.getElementById('multiply-color');
				var current_layer = document.getElementById('current-layer');
				var layer_pointer = document.getElementById('layer-pointer');
				multiply_btn.onclick = function (e) {
					e.preventDefault();
					var color = toRgb(color_picker.value);
					var layer = scene.currentLayer;
					scene.filterLayer(color, layer);
				}
				reset_btn.onclick = function (e) {
					e.preventDefault();
					var layer = scene.currentLayer;
					scene.resetLayer(layer);
				}
				canvas.onmouseenter = function (e) {
					e.preventDefault();
					canvas.style.cursor = 'pointer';
					document.getElementById('layer-pointer').style.display = 'inline';
				}
				canvas.onmouseleave = function (e) {
					e.preventDefault();
					canvas.style.cursor = 'default';
					document.getElementById('layer-pointer').style.display = 'none';
				}
				canvas.onmousemove = function (e) {
					e.preventDefault();
					var x = e.pageX - canvas.offsetLeft;
					var y = e.pageY - canvas.offsetTop;
					var layer = scene.checkLayer(x, y);
					layer_pointer.innerText = '图层' + layer;
					layer_pointer.style.left = x + 20;
					layer_pointer.style.top = y + 8;
				}
				canvas.onclick = function (e) {
					e.preventDefault();
					var x = e.pageX - canvas.offsetLeft;
					var y = e.pageY - canvas.offsetTop;
					var layer = scene.checkLayer(x, y);
					scene.setCurrentL(layer);
					current_layer.innerText = layer;
				}
			})
		</script>
	</head>
	<body>
		<canvas id="mainCanvas" width="100" height="100"></canvas>
		<br>
		<div id="tool-box">
			<small>当前所选图层为：<b id="current-layer">0</b></small>
			<input type="color" id="multiply-color">
	    	<button id="multiply-btn">叠加</button>
	    	<button id="reset-btn">复位</button>
	    	<span id="layer-pointer"></span>
	    </div>
	</body>
</html>